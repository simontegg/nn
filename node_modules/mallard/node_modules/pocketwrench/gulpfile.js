var fs = require('fs');
var gulp = require('gulp');
var changelog = require('conventional-changelog');
var jshint = require('gulp-jshint');
var mocha = require('gulp-mocha');
var istanbul = require('gulp-istanbul');
var stylish = require('jshint-stylish');
var coveralls = require('gulp-coveralls');
var browserify = require('browserify');
var source = require('vinyl-source-stream');

// ------------------------ DEV tasks
gulp.task('test', ['lint'], function () {
    return gulp.src('test/*.js')
        .pipe(mocha({reporter: 'spec'}));
});

gulp.task('lint', function() {
    return gulp.src(['gulpfile.js', 'index.js', 'lib/*.js', 'test/*.js'])
        .pipe(jshint())
        .pipe(jshint.reporter(stylish))
        .pipe(jshint.reporter('fail'));
});

gulp.task('coverage', function(cb) {
  gulp.src(['lib/**/*.js', 'index.js'])
    .pipe(istanbul())
    .on('finish', function () {
      gulp.src(['test/*.js'])
        .pipe(mocha())
        .pipe(istanbul.writeReports())
        .on('end', cb);
    });
});

gulp.task('watch', function() {
    gulp.watch(['lib/*.js', 'index.js'], ['lint', 'test']);
});

gulp.task('coveralls', ['coverage'], function() {
  gulp.src('coverage/**/lcov.info')
  .pipe(coveralls());
});

// ------------------------ RELEASE tasks
gulp.task('browserify', function() {
  browserify('./index.js').bundle()
    .pipe(source('bundle.js'))
    .pipe(gulp.dest('./build'));
});

gulp.task('changelog', function(done){
  function changeParsed(err, log){
    if (err) {
      return done(err);
    }
    fs.writeFile('CHANGELOG.md', log, done);
  }
  fs.readFile('./package.json', 'utf8', function(err, data){
    var ref$, repository, version;
    ref$ = JSON.parse(data);
    repository = ref$.repository;
    version = ref$.version;
    changelog({
      repository: repository.url,
      version: version
    }, changeParsed);
  });
});

gulp.task('default', ['dev']);
gulp.task('dev', ['watch']);
gulp.task('ci', ['lint', 'test', 'coverage', 'coveralls']);
gulp.task('release', ['changelog', 'browserify']);
